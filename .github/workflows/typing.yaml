---
name: Typing

# yamllint disable-line rule:truthy
on:
    push:
    pull_request:
    workflow_dispatch:

jobs:
    mypy:
        name: mypy on Python ${{ matrix.python }}
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python: ["3.10"]
        steps:
            - name: â¤µï¸ Check out code from GitHub
              uses: actions/checkout@v3

            - name: ğŸ— Set up Python ${{ matrix.python }}
              id: python
              uses: actions/setup-python@v3
              with:
                  python-version: ${{ matrix.python }}

            - name: ğŸ— Get pip cache dir
              id: pip-cache
              run: |
                  echo "DIR=$(pip cache dir)" >> $GITHUB_OUTPUT

            - name: â¤µï¸ Restore cached Python PIP packages
              uses: actions/cache@v3
              with:
                  path: ${{ steps.pip-cache.outputs.DIR }}
                  key: pip-${{ runner.os }}-${{ steps.python.outputs.python-version }}-${{ hashFiles('.github/workflows/requirements.txt') }}
                  restore-keys: |
                      pip-${{ runner.os }}-${{ steps.python.outputs.python-version }}-

            - name: ğŸ— Install workflow dependencies
              run: |
                  pip install -r .github/workflows/requirements.txt
                  poetry config virtualenvs.create true
                  poetry config virtualenvs.in-project true

            - name: â¤µï¸ Restore cached Python virtual environment
              id: cached-poetry-dependencies
              uses: actions/cache@v3
              with:
                  path: .venv
                  key: venv-${{ runner.os }}-${{ steps.python.outputs.python-version }}-${{ hashFiles('poetry.lock') }}
                  restore-keys: |
                      venv-${{ runner.os }}-${{ steps.python.outputs.python-version }}-

            - name: ğŸ— Install dependencies
              run: poetry install --no-interaction
            - name: ğŸš€ Run mypy
              run: poetry run mypy examples src tests

    pyright:
        name: pyright on Python ${{ matrix.python }}
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python: ["3.10"]
        steps:
            - name: â¤µï¸ Check out code from GitHub
              uses: actions/checkout@v3

            - name: ğŸ— Set up Python ${{ matrix.python }}
              id: python
              uses: actions/setup-python@v3
              with:
                  python-version: ${{ matrix.python }}

            - name: ğŸ— Read .nvmrc
              id: nvm
              run: echo "NVMRC=$(cat .nvmrc)" >> $GITHUB_OUTPUT

            - name: ğŸ— Set up Node.js ${{ steps.nvm.outputs.NVMRC }}
              uses: actions/setup-node@v3.6.0
              with:
                  node-version: "${{ steps.nvm.outputs.NVMRC }}"

            - name: ğŸ— Get pip cache directory
              id: pip-cache
              run: |
                  echo "DIR=$(pip cache dir)" >> $GITHUB_OUTPUT

            - name: â¤µï¸ Restore cached Python PIP packages
              uses: actions/cache@v3
              with:
                  path: ${{ steps.pip-cache.outputs.DIR }}
                  key: node-${{ runner.os }}-${{ steps.python.outputs.python-version }}-${{ hashFiles('.github/workflows/requirements.txt') }}
                  restore-keys: |
                      pip-${{ runner.os }}-${{ steps.python.outputs.python-version }}-

            - name: ğŸ— Install workflow dependencies
              run: |
                  pip install -r .github/workflows/requirements.txt
                  poetry config virtualenvs.create true
                  poetry config virtualenvs.in-project true

            - name: â¤µï¸ Restore cached Python virtual environment
              id: cached-poetry-dependencies
              uses: actions/cache@v3
              with:
                  path: .venv
                  key: venv-${{ runner.os }}-${{ steps.python.outputs.python-version }}-${{ hashFiles('poetry.lock') }}
                  restore-keys: |
                      venv-${{ runner.os }}-${{ steps.python.outputs.python-version }}-

            - name: ğŸ— Install Python dependencies
              run: poetry install --no-interaction

            - name: ğŸ—  Get npm cache directory
              id: npm-cache
              run: |
                  echo "DIR=$(npm config get cache)" >> $GITHUB_OUTPUT

            - name: â¤µï¸ Restore cached node modules
              uses: actions/cache@v3
              with:
                  path: ${{ steps.npm-cache.outputs.DIR }}
                  key: node-${{ runner.os }}-${{ steps.nvm.outputs.NVMRC }}-${{ hashFiles('.github/workflows/requirements.txt') }}
                  restore-keys: |
                      node-${{ runner.os }}-${{ steps.nvm.outputs.NVMRC }}-

            - name: ğŸ— Install dependencies
              run: |
                  pip install -r .github/workflows/requirements.txt
                  poetry install
                  npm install

            - name: ğŸš€ Run pyright
              run: poetry run npm run pyright
